# PSBT Consolidator CLI

A Node.js command-line tool to generate a Partially Signed Bitcoin Transaction (PSBT) for consolidating Bitcoin Core wallet UTXOs according to specific rules.

Purpose: Minimize (future) fees by combining Bitcoin fund distribution and UXTO consolidation within a single transactions across sender and receiver wallets. I use it to automate a Bitcoin savings plan for my kids.

## Overview

This CLI application interacts exclusively with a running Bitcoin Core instance (v24.0 or higher) via its JSON-RPC interface. Its sole purpose is to:

1.  Gather confirmed, spendable UTXOs associated with a specific `sourceAddress`.
2.  Gather confirmed, spendable UTXOs derived from a list of specified `targetDescriptors`.
3.  Calculate the total input value.
4.  Derive the next unused address for each `targetDescriptor`.
5.  Construct a transaction that sends funds *evenly* to each derived target address.
6.  Calculate the minimum necessary transaction fee to meet a target confirmation time (`feeTargetBlocks`), absorbing any remainder from the even distribution, and accounting for the estimated final signed transaction size (including witness data).
7.  Generate an unsigned PSBT representing this consolidation transaction, ready for inspection and signing.

**This tool DOES NOT sign or broadcast the transaction.**

## Prerequisites

*   **Node.js:** Version 18.x or higher recommended.
*   **Bitcoin Core:** Version 24.0 or higher, running, fully synchronized, and accessible via RPC.
*   **Bitcoin Core Wallet:**
    *   A **descriptor wallet** must be created and loaded in Bitcoin Core.
    *   The specified `operatingWalletName` must match the loaded wallet name.
    *   The `sourceAddress` must be tracked by this wallet (e.g., part of an imported descriptor or generated by one).
    *   All `targetDescriptors` listed in the configuration *must* already be imported into this wallet and have address ranges enabled for tracking (so `listdescriptors` can report a `next_index`).

## Installation

1.  Clone this repository or download the source files (`cli.js`, `package.json`, `logger.js`, `rpcClient.js`, `utils.js`, `bitcoinCoreUtils.js`, `feeCalculator.js`).
2.  Navigate to the project directory in your terminal.
3.  Install dependencies:
    ```bash
    npm install
    ```
    This installs `decimal.js` required for high-precision calculations.

## Configuration

The tool requires a JSON configuration file. Create a file (e.g., `config.json`) with the following structure:

```json
{
  "bitcoinCore": {
    "rpcUrl": "http://127.0.0.1:8332",     // Bitcoin Core RPC endpoint URL
    "rpcUser": "your_rpc_user",           // RPC authentication username (or null if using cookie)
    "rpcPassword": "your_rpc_password",   // RPC authentication password (or null if using cookie)
    "network": "mainnet"                  // "mainnet", "testnet", or "regtest"
  },
  "sourceContext": {
    "operatingWalletName": "my_consolidating_wallet", // Name of the loaded descriptor wallet
    "sourceAddress": "bc1q..."                      // Specific P2WPKH, P2TR, P2SH, or Legacy address
  },
  "targetDescriptors": [                            // Array of target descriptor strings
    "wpkh(tpub.../84'/0'/0'/0/*)#checksum1",       // Must include checksum and end with '/*'
    "tr(tpub.../84'/0'/1'/0/*)#checksum2"
    // Each must be imported and tracked in 'operatingWalletName'
  ],
  "feeTargetBlocks": 50,                          // Desired confirmation target (blocks, integer > 0)
  "outputPsbtFile": "./consolidated_distribution.psbt", // Path to save the generated PSBT
  "logLevel": "info",                             // Logging verbosity: "trace", "debug", "info", "warn", "error"
  // Optional: Controls witness size estimation for fee calculation
  "feeOptions": {
     "estimatedWitnessVBytesPerInput": 28         // Default: 28 (suitable for P2WPKH). Adjust if needed.
  }
}

## Background

All artifacts have been generated without any human modifications by the amazing Gemini 2.5 Pro.
